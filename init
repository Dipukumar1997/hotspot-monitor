#!/bin/bash

APP_NAME="hotspot-monitor"
VERSION="1.0-1"
ARCH="all"

# Clean old build
rm -rf build
mkdir -p build/${APP_NAME}_${VERSION}

# --- CREATE FOLDERS ---
mkdir -p build/${APP_NAME}_${VERSION}/DEBIAN
mkdir -p build/${APP_NAME}_${VERSION}/usr/bin
mkdir -p build/${APP_NAME}_${VERSION}/usr/share/applications
mkdir -p build/${APP_NAME}_${VERSION}/usr/share/icons

# --- COPY PYTHON APPLICATION ---
cp hotspot_usage.py build/${APP_NAME}_${VERSION}/usr/bin/hotspot-monitor
chmod +x build/${APP_NAME}_${VERSION}/usr/bin/hotspot-monitor

# --- ADD ICON ---
cp icon.png build/${APP_NAME}_${VERSION}/usr/share/icons/hotspot-monitor.png

# --- ADD DESKTOP ENTRY ---
cat <<EOF > build/${APP_NAME}_${VERSION}/usr/share/applications/hotspot-monitor.desktop
[Desktop Entry]
Name=Hotspot Monitor
Comment=Shows live WiFi data usage
Exec=hotspot-monitor
Icon=hotspot-monitor
Terminal=false
Type=Application
Categories=Utility;Network;
EOF

# --- DEBIAN CONTROL FILE ---
cat <<EOF > build/${APP_NAME}_${VERSION}/DEBIAN/control
Package: hotspot-monitor
Version: ${VERSION}
Section: utils
Priority: optional
Architecture: ${ARCH}
Maintainer: Dipu <you@example.com>
Description: A lightweight network usage monitor.
Depends: python3, python3-gi, python3-psutil, gir1.2-gtk-3.0, gir1.2-appindicator3-0.1
EOF

# --- BUILD THE PACKAGE ---
dpkg-deb --build build/${APP_NAME}_${VERSION}

echo "-------------------------------------------------------"
echo "Package created:"
echo "build/${APP_NAME}_${VERSION}.deb"
echo "Install it using: sudo dpkg -i build/${APP_NAME}_${VERSION}.deb"
echo "-------------------------------------------------------"

sudo dpkg -i hotspot-monitor.deb
sudo apt --fix-broken install
Icon=network-wireless

systemctl --user stop hotspot-daemon.service
systemctl --user disable hotspot-daemon.service
